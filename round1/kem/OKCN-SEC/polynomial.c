

#include "polynomial.h"

#include "reduce.h"
#include "rng.h"
#include "okcn.h"
#include <stdlib.h>
#include <string.h>

/*
	each index in {0,1,2,3} represents two-bit value: 00, 01, 10, 11. 
	0 - 0 = 0; 1 - 0 = 1; 
	0 - 1 = -1; 1 - 1 = 0;
*/
const int lookup_table[4] = {0, 1, -1, 0};


const unsigned char diversifier[8] = "OKCN-SEC";


// this table defines the visited order in the NTT multiplication.
// In this implementation, we have n = 1024.
const unsigned int reverse_order_table[RLWE_N] = {0, 512, 256, 768, 128, 640, 384, 896, 64, 576, 320, 832, 192, 704, 448, 960, 32, 544, 288, 800, 160, 672, 416, 928, 96, 608, 352, 864, 224, 736, 480, 992, 16, 528, 272, 784, 144, 656, 400, 912, 80, 592, 336, 848, 208, 720, 464, 976, 48, 560, 304, 816, 176, 688, 432, 944, 112, 624, 368, 880, 240, 752, 496, 1008, 8, 520, 264, 776, 136, 648, 392, 904, 72, 584, 328, 840, 200, 712, 456, 968, 40, 552, 296, 808, 168, 680, 424, 936, 104, 616, 360, 872, 232, 744, 488, 1000, 24, 536, 280, 792, 152, 664, 408, 920, 88, 600, 344, 856, 216, 728, 472, 984, 56, 568, 312, 824, 184, 696, 440, 952, 120, 632, 376, 888, 248, 760, 504, 1016, 4, 516, 260, 772, 132, 644, 388, 900, 68, 580, 324, 836, 196, 708, 452, 964, 36, 548, 292, 804, 164, 676, 420, 932, 100, 612, 356, 868, 228, 740, 484, 996, 20, 532, 276, 788, 148, 660, 404, 916, 84, 596, 340, 852, 212, 724, 468, 980, 52, 564, 308, 820, 180, 692, 436, 948, 116, 628, 372, 884, 244, 756, 500, 1012, 12, 524, 268, 780, 140, 652, 396, 908, 76, 588, 332, 844, 204, 716, 460, 972, 44, 556, 300, 812, 172, 684, 428, 940, 108, 620, 364, 876, 236, 748, 492, 1004, 28, 540, 284, 796, 156, 668, 412, 924, 92, 604, 348, 860, 220, 732, 476, 988, 60, 572, 316, 828, 188, 700, 444, 956, 124, 636, 380, 892, 252, 764, 508, 1020, 2, 514, 258, 770, 130, 642, 386, 898, 66, 578, 322, 834, 194, 706, 450, 962, 34, 546, 290, 802, 162, 674, 418, 930, 98, 610, 354, 866, 226, 738, 482, 994, 18, 530, 274, 786, 146, 658, 402, 914, 82, 594, 338, 850, 210, 722, 466, 978, 50, 562, 306, 818, 178, 690, 434, 946, 114, 626, 370, 882, 242, 754, 498, 1010, 10, 522, 266, 778, 138, 650, 394, 906, 74, 586, 330, 842, 202, 714, 458, 970, 42, 554, 298, 810, 170, 682, 426, 938, 106, 618, 362, 874, 234, 746, 490, 1002, 26, 538, 282, 794, 154, 666, 410, 922, 90, 602, 346, 858, 218, 730, 474, 986, 58, 570, 314, 826, 186, 698, 442, 954, 122, 634, 378, 890, 250, 762, 506, 1018, 6, 518, 262, 774, 134, 646, 390, 902, 70, 582, 326, 838, 198, 710, 454, 966, 38, 550, 294, 806, 166, 678, 422, 934, 102, 614, 358, 870, 230, 742, 486, 998, 22, 534, 278, 790, 150, 662, 406, 918, 86, 598, 342, 854, 214, 726, 470, 982, 54, 566, 310, 822, 182, 694, 438, 950, 118, 630, 374, 886, 246, 758, 502, 1014, 14, 526, 270, 782, 142, 654, 398, 910, 78, 590, 334, 846, 206, 718, 462, 974, 46, 558, 302, 814, 174, 686, 430, 942, 110, 622, 366, 878, 238, 750, 494, 1006, 30, 542, 286, 798, 158, 670, 414, 926, 94, 606, 350, 862, 222, 734, 478, 990, 62, 574, 318, 830, 190, 702, 446, 958, 126, 638, 382, 894, 254, 766, 510, 1022, 1, 513, 257, 769, 129, 641, 385, 897, 65, 577, 321, 833, 193, 705, 449, 961, 33, 545, 289, 801, 161, 673, 417, 929, 97, 609, 353, 865, 225, 737, 481, 993, 17, 529, 273, 785, 145, 657, 401, 913, 81, 593, 337, 849, 209, 721, 465, 977, 49, 561, 305, 817, 177, 689, 433, 945, 113, 625, 369, 881, 241, 753, 497, 1009, 9, 521, 265, 777, 137, 649, 393, 905, 73, 585, 329, 841, 201, 713, 457, 969, 41, 553, 297, 809, 169, 681, 425, 937, 105, 617, 361, 873, 233, 745, 489, 1001, 25, 537, 281, 793, 153, 665, 409, 921, 89, 601, 345, 857, 217, 729, 473, 985, 57, 569, 313, 825, 185, 697, 441, 953, 121, 633, 377, 889, 249, 761, 505, 1017, 5, 517, 261, 773, 133, 645, 389, 901, 69, 581, 325, 837, 197, 709, 453, 965, 37, 549, 293, 805, 165, 677, 421, 933, 101, 613, 357, 869, 229, 741, 485, 997, 21, 533, 277, 789, 149, 661, 405, 917, 85, 597, 341, 853, 213, 725, 469, 981, 53, 565, 309, 821, 181, 693, 437, 949, 117, 629, 373, 885, 245, 757, 501, 1013, 13, 525, 269, 781, 141, 653, 397, 909, 77, 589, 333, 845, 205, 717, 461, 973, 45, 557, 301, 813, 173, 685, 429, 941, 109, 621, 365, 877, 237, 749, 493, 1005, 29, 541, 285, 797, 157, 669, 413, 925, 93, 605, 349, 861, 221, 733, 477, 989, 61, 573, 317, 829, 189, 701, 445, 957, 125, 637, 381, 893, 253, 765, 509, 1021, 3, 515, 259, 771, 131, 643, 387, 899, 67, 579, 323, 835, 195, 707, 451, 963, 35, 547, 291, 803, 163, 675, 419, 931, 99, 611, 355, 867, 227, 739, 483, 995, 19, 531, 275, 787, 147, 659, 403, 915, 83, 595, 339, 851, 211, 723, 467, 979, 51, 563, 307, 819, 179, 691, 435, 947, 115, 627, 371, 883, 243, 755, 499, 1011, 11, 523, 267, 779, 139, 651, 395, 907, 75, 587, 331, 843, 203, 715, 459, 971, 43, 555, 299, 811, 171, 683, 427, 939, 107, 619, 363, 875, 235, 747, 491, 1003, 27, 539, 283, 795, 155, 667, 411, 923, 91, 603, 347, 859, 219, 731, 475, 987, 59, 571, 315, 827, 187, 699, 443, 955, 123, 635, 379, 891, 251, 763, 507, 1019, 7, 519, 263, 775, 135, 647, 391, 903, 71, 583, 327, 839, 199, 711, 455, 967, 39, 551, 295, 807, 167, 679, 423, 935, 103, 615, 359, 871, 231, 743, 487, 999, 23, 535, 279, 791, 151, 663, 407, 919, 87, 599, 343, 855, 215, 727, 471, 983, 55, 567, 311, 823, 183, 695, 439, 951, 119, 631, 375, 887, 247, 759, 503, 1015, 15, 527, 271, 783, 143, 655, 399, 911, 79, 591, 335, 847, 207, 719, 463, 975, 47, 559, 303, 815, 175, 687, 431, 943, 111, 623, 367, 879, 239, 751, 495, 1007, 31, 543, 287, 799, 159, 671, 415, 927, 95, 607, 351, 863, 223, 735, 479, 991, 63, 575, 319, 831, 191, 703, 447, 959, 127, 639, 383, 895, 255, 767, 511, 1023};


/*
	This table defines the exponenets of phi used in the the negative wrapped convolution method, with slight difference. 
	In this implementation, we have q = 12289, n = 1024; 
	And phi = 1945 is a primitive (2n)-th root of unity in Fq*.
	
	The former part of the table phi_table[0..n-1] is used in the pre-computation of the negative wrapped convolution method.
	When 0<=j<n, phi_table[j] = (phi^j * R^2) mod q. 
	Here, R=2^15 is used in REDC algorithm.
	
	The latter part of the table phi_table[n..(2n-1)] is used in the post-computation of the negative wrapped convlution method.
	When n<=j<2n, phi_table[j] = (phi^(2n-1-j)*1/n) mod q. 
*/
const unsigned int phi_table[2*RLWE_N] = {2738, 4273, 3621, 1248, 6427, 2602, 10111, 3495, 1958, 11009, 5067, 11826, 8851, 10595, 10911, 11081, 9928, 3941, 9198, 9615, 9606, 4390, 9984, 2260, 8527, 7154, 3382, 3375, 2049, 3669, 8585, 9363, 11026, 1265, 2625, 5690, 6950, 12139, 3186, 3114, 10542, 6138, 5791, 6771, 8076, 2478, 2422, 4103, 4774, 7235, 1170, 2185, 10120, 8711, 8653, 6444, 11089, 910, 334, 10602, 12237, 9461, 5012, 3163, 7535, 7087, 8246, 1325, 8724, 9360, 5191, 7226, 8243, 7779, 2396, 2689, 7280, 2672, 11082, 11873, 1954, 3229, 726, 11124, 7540, 4523, 10600, 8347, 1146, 4661, 8652, 4499, 787, 6879, 9223, 9084, 9087, 2633, 8961, 3343, 1254, 5808, 2969, 11164, 11606, 11066, 5331, 9168, 421, 7771, 11414, 6296, 5876, 50, 11227, 11251, 8775, 10243, 2166, 10032, 9597, 11463, 3289, 6825, 2505, 5781, 11899, 3368, 723, 5289, 1212, 10141, 400, 3793, 3985, 8755, 8210, 5039, 6522, 3042, 5681, 1734, 5444, 7751, 9381, 9169, 2366, 5784, 5445, 9696, 7394, 3200, 5766, 7302, 8595, 4235, 3445, 3020, 12047, 8581, 1583, 6685, 563, 1314, 11907, 6639, 9405, 6693, 3834, 9996, 1022, 9261, 9260, 7315, 9302, 2982, 11871, 10353, 7203, 375, 4324, 4504, 10512, 9233, 3956, 1506, 4388, 6094, 6234, 8176, 354, 346, 9364, 682, 11567, 8945, 9090, 8468, 3000, 10014, 11454, 10362, 130, 7070, 12048, 10526, 11885, 716, 3963, 2832, 2768, 1178, 5456, 6513, 10115, 11275, 6299, 11711, 6378, 5609, 9162, 1040, 7404, 10361, 10474, 9057, 5728, 7126, 10367, 9855, 9424, 6781, 2948, 7186, 4177, 1236, 7665, 1868, 8005, 11851, 8320, 10076, 9154, 10058, 11011, 8957, 7852, 9202, 5106, 1658, 5092, 11295, 8332, 8838, 9888, 12164, 2655, 2595, 8785, 5115, 6874, 11787, 6730, 2065, 10211, 1371, 12171, 3981, 975, 3869, 4337, 5211, 9259, 5370, 11289, 8951, 8471, 8835, 4053, 5836, 8273, 4684, 4231, 7954, 10968, 11345, 7270, 7800, 6374, 10118, 4821, 338, 6093, 4289, 10163, 6323, 9235, 7846, 9821, 4739, 605, 9270, 2187, 1721, 4737, 9004, 955, 1836, 7210, 1701, 2704, 11877, 9734, 7570, 1428, 146, 1323, 4834, 1045, 4840, 426, 5207, 1479, 1029, 10587, 7640, 2399, 8524, 1319, 9343, 8993, 4138, 11404, 11424, 1168, 10584, 1805, 8360, 1853, 3408, 4789, 11832, 8232, 10962, 11964, 6903, 6747, 10552, 1010, 10499, 8526, 5209, 5369, 9344, 10938, 2151, 5435, 2535, 2686, 1445, 8633, 4411, 1673, 9689, 6068, 4820, 10682, 8080, 10258, 6763, 4805, 6085, 1018, 1481, 4919, 6613, 7991, 9199, 11560, 7619, 10710, 1095, 3778, 11677, 1693, 11722, 3195, 8330, 4948, 1573, 11813, 8144, 11848, 2485, 3748, 2483, 12147, 6457, 11796, 11946, 8760, 5646, 7393, 1255, 7753, 982, 5195, 2717, 295, 8481, 3707, 8761, 7591, 5406, 7575, 11153, 2500, 8345, 9545, 8635, 8301, 9988, 10040, 579, 7856, 4693, 9447, 2360, 6403, 5078, 8643, 11572, 6381, 11444, 3201, 7711, 5315, 2626, 7635, 4963, 6170, 6586, 4632, 1403, 677, 1842, 6591, 2068, 3757, 7699, 6553, 1892, 5529, 1030, 243, 5653, 8719, 11924, 2837, 204, 3532, 189, 11224, 5416, 2447, 3572, 4255, 5478, 147, 3268, 2847, 7365, 8240, 1944, 8357, 8307, 9369, 10407, 1632, 3678, 1512, 3769, 6461, 7287, 3998, 9462, 6957, 1176, 1566, 10487, 9764, 4475, 3263, 5411, 5011, 1218, 9522, 767, 4846, 12096, 5574, 2532, 9140, 7406, 1962, 6500, 9408, 239, 10162, 4378, 11222, 1526, 6421, 3221, 9744, 2442, 6136, 1901, 10745, 7725, 7967, 11675, 10092, 3407, 2844, 1530, 1912, 7562, 10446, 3753, 12208, 2212, 1190, 4218, 7247, 12221, 2919, 12226, 355, 2291, 7377, 7002, 2678, 10463, 12240, 3007, 11340, 9834, 5446, 11641, 5407, 9520, 9166, 8820, 11745, 11063, 11785, 2840, 6039, 9860, 6860, 9135, 9970, 11897, 11767, 4697, 4938, 6701, 7105, 6389, 2426, 11883, 9115, 7937, 2481, 8257, 10431, 11445, 5146, 5724, 11635, 6026, 9153, 8113, 709, 2637, 4452, 7684, 1956, 7119, 9041, 11475, 2051, 7559, 4611, 9714, 5537, 4301, 8925, 7057, 11341, 11779, 3459, 5672, 8807, 11038, 27, 3359, 7796, 10883, 5777, 4119, 11316, 21, 3978, 7429, 9830, 9955, 7300, 4705, 8209, 3094, 8509, 9011, 2281, 216, 2294, 923, 1041, 9349, 8374, 4505, 168, 7246, 10276, 4906, 5906, 9244, 773, 4227, 174, 6627, 10643, 5959, 1728, 6063, 7384, 8328, 1058, 5547, 11462, 1344, 8812, 8474, 2381, 10381, 218, 6184, 9238, 1392, 3860, 11410, 10805, 1535, 11637, 9916, 5179, 8464, 7509, 5673, 10752, 9051, 6347, 6759, 9314, 1744, 316, 170, 11136, 6302, 5257, 417, 12280, 7073, 5594, 4565, 6267, 10916, 8517, 12282, 10963, 1620, 4916, 778, 1663, 2528, 1360, 3065, 1260, 5189, 3336, 12217, 7428, 7885, 11942, 980, 1305, 6691, 12233, 1681, 671, 2461, 6224, 1015, 7935, 10880, 12231, 10080, 4645, 2110, 11713, 10268, 1635, 9513, 7840, 10440, 4372, 11841, 1159, 5368, 7399, 636, 8120, 2035, 1017, 11825, 6906, 293, 4591, 7681, 8410, 791, 2370, 1275, 9786, 10398, 8705, 9272, 6077, 10036, 5088, 3515, 3991, 8136, 8577, 6092, 2344, 12150, 3, 5835, 6328, 6671, 10200, 4554, 9450, 8195, 442, 11749, 6554, 3837, 3542, 7350, 3643, 7171, 11869, 6463, 11177, 24, 9813, 1468, 4212, 7866, 11854, 1866, 4115, 3536, 7969, 3276, 6118, 3758, 9644, 4566, 8212, 8929, 2548, 3393, 192, 4770, 11744, 9118, 1483, 8809, 2639, 8342, 3710, 2307, 1630, 12077, 5486, 3418, 11950, 4251, 9987, 8095, 2566, 1536, 1293, 7929, 11499, 11864, 9027, 8823, 5291, 5102, 6167, 751, 10593, 7021, 2766, 9577, 9430, 6162, 3315, 8239, 12288, 10344, 1987, 5969, 8889, 10771, 9139, 5461, 3949, 180, 6008, 11010, 7012, 9839, 2882, 1706, 140, 1942, 4467, 12281, 9018, 3607, 10885, 9667, 145, 11667, 6821, 7014, 1440, 11197, 2057, 6940, 4978, 10767, 1359, 1120, 3247, 11158, 12225, 10699, 4278, 1057, 3602, 1160, 7313, 5412, 6956, 11520, 3553, 4167, 6364, 2957, 113, 10872, 8960, 1398, 3241, 11777, 11858, 9646, 8456, 4238, 9280, 9348, 6429, 6492, 6137, 3846, 8758, 1756, 11367, 904, 953, 10235, 11184, 1350, 8193, 8841, 3434, 6203, 9326, 506, 1050, 2276, 2780, 12229, 6190, 8619, 1759, 4913, 7232, 7624, 8146, 3449, 10800, 4099, 9283, 2894, 468, 874, 4048, 8400, 5919, 9951, 11809, 364, 7507, 1783, 2437, 8700, 11836, 3723, 3014, 377, 8214, 530, 10863, 3744, 6992, 7806, 5755, 10485, 5874, 8449, 2912, 10900, 1975, 7207, 8155, 8665, 5206, 11823, 3016, 4267, 4240, 881, 5374, 6780, 1003, 9173, 10146, 10125, 6147, 11007, 1177, 3511, 8500, 3795, 7875, 4781, 8561, 11839, 9558, 9342, 7048, 6125, 5084, 8024, 11939, 7434, 7266, 20, 2033, 9416, 3510, 6555, 5782, 1555, 1381, 7043, 8689, 2730, 1002, 7228, 12133, 3805, 2747, 9489, 10316, 8972, 160, 3975, 1594, 3502, 3284, 9389, 151, 11048, 7188, 8067, 11051, 734, 2106, 3933, 5927, 933, 8202, 1768, 10129, 1638, 3059, 1879, 4822, 2283, 4106, 10609, 1274, 7841, 96, 2385, 5872, 4559, 6886, 10549, 7464, 4171, 1855, 7298, 815, 12183, 2743, 1709, 5975, 8270, 11138, 10192, 1283, 768, 6791, 10109, 11894, 5932, 10658, 10556, 8790, 2551, 9228, 6520, 11441, 9655, 1383, 10933, 4715, 3081, 7802, 10264, 6144, 5172, 7138, 9129, 10589, 11530, 10714, 8875, 8119, 90, 3004, 5505, 3506, 11064, 1441, 853, 70, 971, 8378, 12285, 4509, 7948, 11587, 10978, 6217, 11978, 9555, 3507, 720, 11743, 7173, 3470, 2489, 11528, 6824, 560, 7768, 5579, 12257, 11494, 2139, 6673, 1801, 580, 9801, 2706, 3478, 5760, 7921, 8228, 3182, 7623, 6201, 5436, 4480, 699, 7765, 12033, 5929, 4823, 4228, 2119, 4640, 4674, 9359, 3246, 9213, 1923, 4379, 878, 11828, 452, 6621, 11262, 5592, 675, 10241, 10565, 1717, 9246, 4663, 253, 525, 1138, 1390, 12259, 3095, 10454, 7024, 8601, 3616, 3812, 4073, 7869, 5400, 8194, 10786, 1447, 234, 437, 2024, 4200, 9104, 11120, 12049, 182, 9898, 7036, 7363, 4350, 5918, 8006, 1507, 6333, 4107, 265, 11576, 1872, 3496, 3903, 9022, 11387, 2937, 10369, 1456, 5450, 7132, 9748, 10222, 10477, 2603, 12056, 1508, 8278, 2120, 6585, 2687, 3390, 6646, 10731, 5073, 11207, 9218, 11648, 6733, 7900, 4250, 8042, 10082, 8535, 10425, 12064, 4779, 4671, 3524, 9207, 2542, 4012, 12114, 3717, 3633, 10, 7161, 4708, 1755, 9422, 2891, 6922, 6835, 9666, 10489, 1365, 501, 3614, 12211, 8047, 7518, 10889, 5158, 4486, 80, 8132, 797, 1751, 1642, 10839, 6220, 5524, 3594, 10178, 10920, 4008, 4334, 11665, 2931, 10988, 1089, 4397, 11310, 640, 3611, 6376, 1719, 847, 689, 604, 7325, 4174, 7690, 1337, 7486, 10094, 7297, 11159, 1881, 8712, 10598, 4457, 5120, 4310, 1852, 1463, 6776, 5512, 4832, 9444, 8814, 75, 10696, 10732, 7018, 9220, 3249, 2759, 8251, 11050, 11078, 4093, 9902, 2527, 11704, 5052, 7229, 1789, 1818, 9067, 600, 11834, 12122, 6988, 26, 1414, 9783, 4563, 2377, 2601, 8166, 5482, 7927, 7609, 3549, 8676, 2023, 2255, 11091, 4800, 8649, 10953, 6748, 208, 11312, 4530, 11926, 6727, 8519, 3883, 6989, 1971, 11716, 3814, 7963, 3895, 5751, 2705, 1533, 7747, 1601, 4828, 1664, 4473, 11662, 9385, 4660, 6707, 6486, 6756, 3479, 7705, 5934, 2259, 6582, 9141, 9351, 12264, 531, 519, 1757, 1023, 11206, 7273, 1346, 413, 4500, 2732, 4892, 3254, 195, 10605, 5783, 3500, 11683, 1074, 12089, 4248, 4152, 1767, 8184, 3625, 9028, 10768, 3304, 11422, 9567, 2269, 1454, 1560, 11106, 9397, 3422, 7441, 8592, 10689, 9406, 8638, 1847, 4027, 4422, 10779, 121, 1854, 5353, 2802, 5863, 11632, 191, 2825, 1442, 2798, 10372, 7291, 11778, 1514, 7659, 2487, 7638, 10798, 209, 968, 2543, 5957, 10127, 10037, 7033, 1528, 10311, 11536, 10095, 9242, 9172, 8201, 12112, 12116, 7607, 11948, 361, 1672, 7744, 8055, 10789, 7282, 6562, 7108, 12224, 8754, 6265, 7026, 202, 11931, 4163, 10873, 10905, 11700, 9561, 2888, 1087, 507, 2995, 289, 9100, 3340, 7708, 11769, 8587, 964, 7052, 1616, 9425, 8726, 961, 1217, 7577, 2754, 10815, 8696, 4056, 11671, 2312, 11355, 2142, 219, 8129, 7251, 7712, 7260, 639, 1666, 8363, 7688, 9736, 11460, 9743, 497, 8123, 7870, 7345, 6207, 4817, 4847, 1752, 3587, 8852, 251, 8924, 5112, 1039, 5459, 59, 4154, 5657, 4210, 3976, 3539, 1515, 9604, 500, 1669, 1909, 1727, 4118, 9371, 2008, 9947, 4029, 8312, 6805, 472, 8654, 8389, 9102, 7230, 3734, 12120, 3098, 4000, 1063, 2983, 1527, 8366, 1234, 3775, 5842, 7654, 5051, 5284, 3776, 7787, 5667, 11371, 8684, 5294, 10937, 206, 7422, 8504, 11575, 12216, 5483, 9872, 5622, 9869, 12076, 3541, 5405, 5630, 851, 8469, 4945, 8027, 5485, 1473, 1648, 10220, 6587, 6577, 11705, 6997, 5242, 8109, 5218, 10585, 3750, 6373, 8173, 6808, 6307, 2693, 2771, 7013, 11784, 895, 8026, 3540, 3460, 7617, 6820, 5069, 3427, 4877, 10946, 5422, 1828, 3939, 5308, 1300, 9255, 9879, 6948, 8249, 7160, 2763, 3742, 3102, 11780, 5404, 3685, 2838, 2149, 1545, 6509, 2335, 6934, 5597, 10400, 306, 5298, 6428, 4547, 8124, 9815, 5358, 238, 8217, 6365, 4902, 10415, 4903, 71, 2916, 6391, 6316, 7909, 9466, 2448, 5517, 2268, 11798, 3547, 4786, 5997, 1904, 4291, 1764, 2349, 9586, 2357, 568, 11039, 1972, 1372, 1827, 1994, 7295, 7269, 5855, 8361, 3798, 1421, 11109, 2943, 9750, 1823, 6503, 2954, 6567, 4544, 2289, 3487, 10976, 2327, 3663, 9204, 8996, 9973, 5443, 5806, 11368, 2849, 11255, 4266, 2295, 2868, 11343, 3380, 11774, 6023, 3318, 1785, 6327, 4726, 12187, 10523, 6050, 6677, 9581, 4921, 10503, 4017, 9550, 6071, 10655, 4721, 2462, 8169, 11317, 1966, 1991, 1460, 941, 11473, 10450, 11533, 4260, 2914, 2501, 10290, 7558, 2666, 11701, 11506, 901, 7407, 3907, 4513, 3439, 3639, 11680, 7528, 5761, 9866, 6241, 9502, 11023, 7719, 8586, 11308, 9039, 7585, 6025, 7208, 10100, 6678, 11526, 2934, 4534, 7417, 11068, 9221, 5194, 772, 2282, 2161, 307, 7243, 4441, 10867, 11524, 11333, 8508, 7066, 4268, 6185, 11183, 11694, 10180, 2521, 34, 4685, 6176, 5967, 4999, 2456, 8788, 10950, 913, 6169, 4641, 6619, 7372, 9566, 324, 3441, 7529, 7706, 7879, 272, 613, 252, 10869, 3125, 7359, 8859, 1577, 7304, 196, 261, 3796, 9820, 2794, 2592, 2950, 11076, 203, 1587, 2176, 4904, 2016, 929, 422, 9716, 9427, 327, 9276, 1568, 2088, 5790, 4826, 10063, 8447, 11311, 2585, 1624, 407, 5119, 2365, 3839, 7432, 3376, 3994, 1682, 2616, 474, 255, 4415, 9453, 1741, 6770, 6131, 4465, 8391, 703, 3256, 4085, 6631, 6134, 10300, 2430, 7374, 1167, 8639, 3792, 2040, 10742, 1890, 1639, 5004, 12181, 11142, 5683, 5624, 1470, 8102, 3892, 12205, 8666, 7151, 9836, 9336, 7667, 5758, 4031, 12202, 2831, 823, 3165, 11425, 3113, 8597, 8125, 11760, 3371, 6558, 11617, 7883, 8052, 4954, 954, 12180, 9197, 7670, 11593, 10359, 6584, 742, 5377, 326, 7331, 3555, 8057, 2390, 3308, 6913, 1619, 2971, 2765, 7632, 11417, 12131, 12204, 6721, 9138, 3516, 5936, 6149, 2608, 9492, 3862, 3011, 6831, 1886, 6148, 663, 11479, 9831, 11900, 5313, 11025, 11609, 4612, 11659, 3550, 10621, 36, 8575, 2202, 6318, 11799, 5492, 2799, 28, 5304, 5809, 4914, 9177, 5637, 2177, 6849, 29, 7249, 3822, 11234, 288, 7155, 5327, 1388, 8369, 7069, 10103, 224, 5565, 9605, 2445, 11971, 8229, 5127, 5636, 232, 8836, 5998, 3849, 2304, 8084, 5749, 11104, 5507, 7396, 7090, 1792, 7653, 3106, 7271, 9745, 4387, 4149, 8221, 1856, 9243, 11117, 6214, 6143, 3227, 9125, 2809, 7189, 10012, 7564, 2047, 12068, 270, 9012, 4226, 10518, 8614, 4323, 2559, 210, 2913, 556, 12277};


/*
	This tables is used in the bufferfly operation of the NTT transform and the inverse NTT transform.
	In this implementation, we have q = 12289, n = 1024; 
	And omega = 10302 is a primitive (n)-th root of unity in Fq*. 
	
	For every 0<=j<n/2, we have omega_table[j] = (omega^j mod q);
	For every n/2<=j<n, we have omega_table[j] = (omgea^(j+1) mod q). 
*/
const unsigned int omega_table[RLWE_N] = {1, 10302, 3400, 3150, 8340, 6281, 5277, 9407, 12149, 7822, 3271, 1404, 12144, 5468, 10849, 10232, 7311, 10930, 9042, 64, 8011, 8687, 4976, 5333, 8736, 5925, 12176, 3329, 9048, 431, 3833, 3009, 5860, 6152, 3531, 922, 11336, 1105, 4096, 8855, 2963, 11239, 9509, 6099, 10530, 5057, 4143, 1489, 3006, 11821, 8241, 6370, 480, 4782, 9852, 453, 9275, 4075, 1426, 5297, 6534, 6415, 9377, 10314, 4134, 7083, 9273, 8049, 6915, 11286, 2143, 6142, 11112, 3789, 4414, 3728, 2731, 5241, 7205, 350, 5023, 10256, 8779, 6507, 10908, 3600, 11287, 156, 9542, 1973, 12129, 10695, 9005, 12138, 5101, 2738, 3621, 6427, 10111, 1958, 5067, 8851, 10911, 9928, 9198, 9606, 9984, 8527, 3382, 2049, 8585, 11026, 2625, 6950, 3186, 10542, 5791, 8076, 2422, 4774, 1170, 10120, 8653, 11089, 334, 12237, 5012, 7535, 8246, 8724, 5191, 8243, 2396, 7280, 11082, 1954, 726, 7540, 10600, 1146, 8652, 787, 9223, 9087, 8961, 1254, 2969, 11606, 5331, 421, 11414, 5876, 11227, 8775, 2166, 9597, 3289, 2505, 11899, 723, 1212, 400, 3985, 8210, 6522, 5681, 5444, 9381, 2366, 5445, 7394, 5766, 8595, 3445, 12047, 1583, 563, 11907, 9405, 3834, 1022, 9260, 9302, 11871, 7203, 4324, 10512, 3956, 4388, 6234, 354, 9364, 11567, 9090, 3000, 11454, 130, 12048, 11885, 3963, 2768, 5456, 10115, 6299, 6378, 9162, 7404, 10474, 5728, 10367, 9424, 2948, 4177, 7665, 8005, 8320, 9154, 11011, 7852, 5106, 5092, 8332, 9888, 2655, 8785, 6874, 6730, 10211, 12171, 975, 4337, 9259, 11289, 8471, 4053, 8273, 4231, 10968, 7270, 6374, 4821, 6093, 10163, 9235, 9821, 605, 2187, 4737, 955, 7210, 2704, 9734, 1428, 1323, 1045, 426, 1479, 10587, 2399, 1319, 8993, 11404, 1168, 1805, 1853, 4789, 8232, 11964, 6747, 1010, 8526, 5369, 10938, 5435, 2686, 8633, 1673, 6068, 10682, 10258, 4805, 1018, 4919, 7991, 11560, 10710, 3778, 1693, 3195, 4948, 11813, 11848, 3748, 12147, 11796, 8760, 7393, 7753, 5195, 295, 3707, 7591, 7575, 2500, 9545, 8301, 10040, 7856, 9447, 6403, 8643, 6381, 3201, 5315, 7635, 6170, 4632, 677, 6591, 3757, 6553, 5529, 243, 8719, 2837, 3532, 11224, 2447, 4255, 147, 2847, 8240, 8357, 9369, 1632, 1512, 6461, 3998, 6957, 1566, 9764, 3263, 5011, 9522, 4846, 5574, 9140, 1962, 9408, 10162, 11222, 6421, 9744, 6136, 10745, 7967, 10092, 2844, 1912, 10446, 12208, 1190, 7247, 2919, 355, 7377, 2678, 12240, 11340, 5446, 5407, 9166, 11745, 11785, 6039, 6860, 9970, 11767, 4938, 7105, 2426, 9115, 2481, 10431, 5146, 11635, 9153, 709, 4452, 1956, 9041, 2051, 4611, 5537, 8925, 11341, 3459, 8807, 27, 7796, 5777, 11316, 3978, 9830, 7300, 8209, 8509, 2281, 2294, 1041, 8374, 168, 10276, 5906, 773, 174, 10643, 1728, 7384, 1058, 11462, 8812, 2381, 218, 9238, 3860, 10805, 11637, 5179, 7509, 10752, 6347, 9314, 316, 11136, 5257, 12280, 5594, 6267, 8517, 10963, 4916, 1663, 1360, 1260, 3336, 7428, 11942, 1305, 12233, 671, 6224, 7935, 12231, 4645, 11713, 1635, 7840, 4372, 1159, 7399, 8120, 1017, 6906, 4591, 8410, 2370, 9786, 8705, 6077, 5088, 3991, 8577, 2344, 3, 6328, 10200, 9450, 442, 6554, 3542, 3643, 11869, 11177, 9813, 4212, 11854, 4115, 7969, 6118, 9644, 8212, 2548, 192, 11744, 1483, 2639, 3710, 1630, 5486, 11950, 9987, 2566, 1293, 11499, 9027, 5291, 6167, 10593, 2766, 9430, 3315, 1987, 8889, 9139, 3949, 6008, 7012, 2882, 140, 4467, 9018, 10885, 145, 6821, 1440, 2057, 4978, 1359, 3247, 12225, 4278, 3602, 7313, 6956, 3553, 6364, 113, 8960, 3241, 11858, 8456, 9280, 6429, 6137, 8758, 11367, 953, 11184, 8193, 3434, 9326, 1050, 2780, 6190, 1759, 7232, 8146, 10800, 9283, 468, 4048, 5919, 11809, 7507, 2437, 11836, 3014, 8214, 10863, 6992, 5755, 5874, 2912, 1975, 8155, 5206, 3016, 4240, 5374, 1003, 10146, 6147, 1177, 8500, 7875, 8561, 9558, 7048, 5084, 11939, 7266, 2033, 3510, 5782, 1381, 8689, 1002, 12133, 2747, 10316, 160, 1594, 3284, 151, 7188, 9551, 8668, 5862, 2178, 10331, 7222, 3438, 1378, 2361, 3091, 2683, 2305, 3762, 8907, 10240, 3704, 1263, 9664, 5339, 9103, 1747, 6498, 4213, 9867, 7515, 11119, 2169, 3636, 1200, 11955, 52, 7277, 4754, 4043, 3565, 7098, 4046, 9893, 5009, 1207, 10335, 11563, 4749, 1689, 11143, 3637, 11502, 3066, 3202, 3328, 11035, 9320, 683, 6958, 11868, 875, 6413, 1062, 3514, 10123, 2692, 9000, 9784, 390, 11566, 11077, 11889, 8304, 4079, 5767, 6608, 6845, 2908, 9923, 6844, 4895, 6523, 3694, 8844, 242, 10706, 11726, 382, 2884, 8455, 11267, 3029, 2987, 418, 5086, 7965, 1777, 8333, 7901, 6055, 11935, 2925, 722, 3199, 9289, 835, 12159, 241, 404, 8326, 9521, 6833, 2174, 5990, 5911, 3127, 4885, 1815, 6561, 1922, 2865, 9341, 8112, 4624, 4284, 3969, 3135, 1278, 4437, 7183, 7197, 3957, 2401, 9634, 3504, 5415, 5559, 2078, 118, 11314, 7952, 3030, 1000, 3818, 8236, 4016, 8058, 1321, 5019, 5915, 7468, 6196, 2126, 3054, 2468, 11684, 10102, 7552, 11334, 5079, 9585, 2555, 10861, 10966, 11244, 11863, 10810, 1702, 9890, 10970, 3296, 885, 11121, 10484, 10436, 7500, 4057, 325, 5542, 11279, 3763, 6920, 1351, 6854, 9603, 3656, 10616, 6221, 1607, 2031, 7484, 11271, 7370, 4298, 729, 1579, 8511, 10596, 9094, 7341, 476, 441, 8541, 142, 493, 3529, 4896, 4536, 7094, 11994, 8582, 4698, 4714, 9789, 2744, 3988, 2249, 4433, 2842, 5886, 3646, 5908, 9088, 6974, 4654, 6119, 7657, 11612, 5698, 8532, 5736, 6760, 12046, 3570, 9452, 8757, 1065, 9842, 8034, 12142, 9442, 4049, 3932, 2920, 10657, 10777, 5828, 8291, 5332, 10723, 2525, 9026, 7278, 2767, 7443, 6715, 3149, 10327, 2881, 2127, 1067, 5868, 2545, 6153, 1544, 4322, 2197, 9445, 10377, 1843, 81, 11099, 5042, 9370, 11934, 4912, 9611, 49, 949, 6843, 6882, 3123, 544, 504, 6250, 5429, 2319, 522, 7351, 5184, 9863, 3174, 9808, 1858, 7143, 654, 3136, 11580, 7837, 10333, 3248, 10238, 7678, 6752, 3364, 948, 8830, 3482, 12262, 4493, 6512, 973, 8311, 2459, 4989, 4080, 3780, 10008, 9995, 11248, 3915, 12121, 2013, 6383, 11516, 12115, 1646, 10561, 4905, 11231, 827, 3477, 9908, 12071, 3051, 8429, 1484, 652, 7110, 4780, 1537, 5942, 2975, 11973, 1153, 7032, 9, 6695, 6022, 3772, 1326, 7373, 10626, 10929, 11029, 8953, 4861, 347, 10984, 56, 11618, 6065, 4354, 58, 7644, 576, 10654, 4449, 7917, 11130, 4890, 4169, 11272, 5383, 7698, 3879, 9919, 2503, 3584, 6212, 7201, 8298, 3712, 9945, 12286, 5961, 2089, 2839, 11847, 5735, 8747, 8646, 420, 1112, 2476, 8077, 435, 8174, 4320, 6171, 2645, 4077, 9741, 12097, 545, 10806, 9650, 8579, 10659, 6803, 339, 2302, 9723, 10996, 790, 3262, 6998, 6122, 1696, 9523, 2859, 8974, 1};


/*
	This tables is used in the bufferfly operation of the NTT transform and the inverse NTT transform.
	In this implementation, we have q = 12289, n = 1024; 
	And omega = 10302 is a primitive (n)-th root of unity in Fq*. 
	
	For every j, translated_omega_table[j] = floor(omega_table[j] * 2^16 / q). 
*/
const unsigned int translated_omega_table[RLWE_N] = {5, 54939, 18131, 16798, 44476, 33495, 28141, 50166, 64789, 41713, 17443, 7487, 64762, 29160, 57856, 54566, 38988, 58288, 48220, 341, 42721, 46326, 26536, 28440, 46588, 31597, 64933, 17753, 48252, 2298, 20441, 16046, 31250, 32807, 18830, 4916, 60453, 5892, 21843, 47222, 15801, 59936, 50710, 32525, 56155, 26968, 22094, 7940, 16030, 63040, 43948, 33970, 2559, 25501, 52539, 2415, 49462, 21731, 7604, 28248, 34845, 34210, 50006, 55003, 22046, 37772, 49451, 42924, 36876, 60187, 11428, 32754, 59259, 20206, 23539, 19881, 14564, 27949, 38423, 1866, 26787, 54694, 46817, 34701, 58171, 19198, 60192, 831, 50886, 10521, 64682, 57035, 48022, 64730, 27203, 14601, 19310, 34274, 53920, 10441, 27021, 47201, 58187, 52945, 49052, 51227, 53243, 45473, 18035, 10927, 45782, 58800, 13998, 37063, 16990, 56219, 30882, 43068, 12916, 25459, 6239, 53968, 46145, 59136, 1781, 65258, 26728, 40183, 43975, 46524, 27683, 43959, 12777, 38823, 59099, 10420, 3871, 40210, 56528, 6111, 46140, 4196, 49185, 48460, 47788, 6687, 15833, 61893, 28429, 2245, 60869, 31336, 59872, 46796, 11551, 51179, 17539, 13358, 63456, 3855, 6463, 2133, 21251, 43783, 34781, 30296, 29032, 50027, 12617, 29037, 39431, 30749, 45836, 18371, 64245, 8441, 3002, 63498, 50155, 20446, 5450, 49382, 49606, 63306, 38412, 23059, 56059, 21096, 23400, 33245, 1887, 49937, 61685, 48476, 15998, 61083, 693, 64250, 63381, 21134, 14761, 29096, 53942, 33591, 34013, 48860, 39484, 55856, 30546, 55286, 50257, 15721, 22275, 40876, 42689, 44369, 48817, 58720, 41873, 27229, 27155, 44433, 52731, 14158, 46849, 36658, 35890, 54454, 64906, 5199, 23128, 49377, 60203, 45174, 21614, 44119, 22563, 58491, 38770, 33991, 25709, 32493, 54198, 49249, 52374, 3226, 11663, 25261, 5092, 38450, 14420, 51910, 7615, 7055, 5572, 2271, 7887, 56459, 12793, 7034, 47958, 60816, 6228, 9625, 9881, 25539, 43900, 63802, 35981, 5386, 45468, 28632, 58331, 28984, 14324, 46038, 8921, 32360, 56966, 54704, 25624, 5428, 26232, 42615, 61648, 57115, 20147, 9028, 17038, 26387, 62997, 63184, 19987, 64778, 62906, 46716, 39426, 41345, 27704, 1573, 19769, 40482, 40396, 13332, 50902, 44268, 53542, 41895, 50379, 34146, 46092, 34029, 17070, 28344, 40716, 32903, 24701, 3610, 35149, 20035, 34946, 29485, 1295, 46497, 15129, 18835, 59856, 13049, 22691, 783, 15182, 43943, 44567, 49963, 8703, 8063, 34455, 21320, 37100, 8351, 52070, 17401, 26723, 50779, 25843, 29725, 48742, 10463, 50171, 54192, 59845, 34242, 51963, 32722, 57302, 42487, 53819, 15166, 10196, 55707, 65104, 6346, 38647, 15566, 1893, 39340, 14281, 65274, 60475, 29042, 28834, 48881, 62634, 62848, 32205, 36583, 53169, 62752, 26333, 37890, 12937, 48609, 13230, 55627, 27443, 62048, 48812, 3781, 23742, 10431, 48214, 10937, 24589, 29528, 47596, 60480, 18446, 46966, 143, 41575, 30808, 60347, 21214, 52422, 38930, 43777, 45377, 12164, 12233, 5551, 44657, 895, 54800, 31496, 4122, 927, 56758, 9215, 39378, 5642, 61125, 46993, 12697, 1162, 49265, 20584, 57621, 62058, 27619, 40044, 57339, 33847, 49670, 1685, 59387, 28035, 65488, 29832, 33421, 45420, 58464, 26216, 8868, 7252, 6719, 17790, 39612, 63685, 6959, 65237, 3578, 33191, 42316, 65226, 24771, 62464, 8719, 41809, 23315, 6180, 39458, 43303, 5423, 36829, 24483, 44849, 12638, 52187, 46422, 32408, 27133, 21283, 45740, 12500, 15, 33746, 54395, 50395, 2357, 34951, 18889, 19427, 63296, 59605, 52331, 22462, 63216, 21944, 42497, 32626, 51430, 43793, 13588, 1023, 62629, 7908, 14073, 19785, 8692, 29256, 63728, 53259, 13684, 6895, 61323, 48140, 28216, 32887, 56491, 14750, 50289, 17678, 10596, 47404, 48737, 21059, 32040, 37394, 15369, 746, 23822, 48092, 58048, 773, 36375, 7679, 10969, 26547, 7247, 17315, 65194, 22814, 19209, 38999, 37095, 18947, 33938, 602, 47782, 17283, 63237, 45094, 49489, 34285, 32728, 46705, 60619, 5082, 59643, 43692, 18313, 49734, 5599, 14825, 33010, 9380, 38567, 43441, 57595, 49505, 2495, 21587, 31565, 62976, 40034, 12996, 63120, 16073, 43804, 57931, 37287, 30690, 31325, 15529, 10532, 43489, 27763, 16084, 22611, 28659, 5348, 54107, 32781, 6276, 45329, 41996, 45654, 50971, 37586, 27112, 63669, 38748, 10841, 18718, 30834, 7364, 46337, 5343, 64704, 14649, 55014, 853, 8500, 17513, 805, 38332, 50934, 46225, 31261, 11615, 55094, 38514, 18334, 7348, 12590, 16483, 14308, 12292, 20062, 47500, 54608, 19753, 6735, 51537, 28472, 48545, 9316, 34653, 22467, 52619, 40076, 59296, 11567, 19390, 6399, 63754, 277, 38807, 25352, 21560, 19011, 37852, 21576, 52758, 26712, 6436, 55115, 61664, 25325, 9007, 59424, 19395, 61339, 16350, 17075, 17747, 58848, 49702, 3642, 37106, 63290, 4666, 34199, 5663, 18739, 53984, 14356, 47996, 52177, 2079, 61680, 59072, 63402, 44284, 21752, 30754, 35239, 36503, 15508, 52918, 36498, 26104, 34786, 19699, 47164, 1290, 57094, 62533, 2037, 15380, 45089, 60085, 16153, 15929, 2229, 27123, 42476, 9476, 44439, 42135, 32290, 63648, 15598, 3850, 17059, 49537, 4452, 64842, 1285, 2154, 44401, 50774, 36439, 11593, 31944, 31522, 16675, 26051, 9679, 34989, 10249, 15278, 49814, 43260, 24659, 22846, 21166, 16718, 6815, 23662, 38306, 38380, 21102, 12804, 51377, 18686, 28877, 29645, 11081, 629, 60336, 42407, 16158, 5332, 20361, 43921, 21416, 42972, 7044, 26765, 31544, 39826, 33042, 11337, 16286, 13161, 62309, 53872, 40274, 60443, 27085, 51115, 13625, 57920, 58480, 59963, 63264, 57648, 9076, 52742, 58501, 17577, 4719, 59307, 55910, 55654, 39996, 21635, 1733, 29554, 60149, 20067, 36903, 7204, 36551, 51211, 19497, 56614, 33175, 8569, 10831, 39911, 60107, 39303, 22920, 3887, 8420, 45388, 56507, 48497, 39148, 2538, 2351, 45548, 757, 2629, 18819, 26109, 24190, 37831, 63962, 45766, 25053, 25139, 52203, 14633, 21267, 11993, 23640, 15156, 31389, 19443, 31506, 48465, 37191, 24819, 32632, 40834, 61925, 30386, 45500, 30589, 36050, 64240, 19038, 50406, 46700, 5679, 52486, 42844, 64752, 50353, 21592, 20968, 15572, 56832, 57472, 31080, 44215, 28435, 57184, 13465, 48134, 38812, 14756, 39692, 35810, 16793, 55072, 15364, 11343, 5690, 31293, 13572, 32813, 8233, 23048, 11716, 50369, 55339, 9828, 431, 59189, 26888, 49969, 63642, 26195, 51254, 261, 5060, 36493, 36701, 16654, 2901, 2687, 33330, 28952, 12366, 2783, 39202, 27645, 52598, 16926, 52305, 9908, 38092, 3487, 16723, 61754, 41793, 55104, 17321, 54598, 40946, 36007, 17939, 5055, 47089, 18569, 65392, 23960, 34727, 5188, 44321, 13113, 26605, 21758, 20158, 53371, 53302, 59984, 20878, 64640, 10735, 34039, 61413, 64608, 8777, 56320, 26157, 59893, 4410, 18542, 52838, 64373, 16270, 44951, 7914, 3477, 37916, 25491, 8196, 31688, 15865, 63850, 6148, 37500, 47, 35703, 32114, 20115, 7071, 39319, 56667, 58283, 58816, 47745, 25923, 1850, 58576, 298, 61957, 32344, 23219, 309, 40764, 3071, 56816, 23726, 42220, 59355, 26077, 22232, 60112, 28706, 41052, 20686, 52897, 13348, 19113, 33127, 38402, 44252, 19795, 53035, 65520, 31789, 11140, 15140, 63178, 30584, 46646, 46108, 2239, 5930, 13204, 43073, 2319, 43591, 23038, 32909, 14105, 21742, 51947, 64512, 2906, 57627, 51462, 45750, 56843, 36279, 1807, 12276, 51851, 58640, 4212, 17395, 37319, 32648, 9044, 50785, 15246, 47857, 5};


/*
	It performs the NTT transform on ptr when direction=1, 
	and performs the inverse NTT transform on ptr when direction=-1.
	
	Note: every coefficient in ptr contains an extra R factor initially.
*/
void Poly_NTT_transform(Polynomial * ptr, const int direction)
{
	unsigned int base = 0;

	unsigned int m = RLWE_N/2; 
	unsigned int interval_length = 1;

	unsigned int i,j,k, temp, index;

	if(direction == -1)
		base = RLWE_N-1;
	else
		Poly_pre_NTT_computation(ptr);

	for(i=0; i<LOG2N; i++)
	{
		for(j=0; j<interval_length; j++)
		{
			temp = 2*j*m;
			index = 0;
			
			for(k=0; k<m; k++, index+=interval_length)
				Butterfly(
					&(ptr->coefficients[temp+k]), 
					&(ptr->coefficients[temp+k+m]), 
					base + direction * index
				);
		}

		// update states
		interval_length = interval_length<<1;
        m = m>>1;
	}

	for(i=0; i<RLWE_N; i++)
	{
		j = reverse_order_table[i];
		if(i < j)
		{
			temp = ptr->coefficients[i];
			ptr->coefficients[i] = ptr->coefficients[j];
			ptr->coefficients[j] = temp;
		}
	}	

	if(direction==-1)
		Poly_post_NTT_computation(ptr);
}


// It performs the butterfly opertion on X and Y
// After: [X,Y] := [X+Y, (X-Y)*omega_table[index]]
void Butterfly(unsigned int * X, unsigned int * Y, const unsigned int index)
{
	unsigned int difference = 2*RLWE_Q + *X - *Y;
	unsigned int temp = (translated_omega_table[index] * difference) >> K_IN_BUTTERFLY;
	*X = Mod2Q(*X+*Y);
	*Y = (omega_table[index] * difference - temp * RLWE_Q) & ((1<<K_IN_BUTTERFLY)-1);
}


// It computes product := poly_a * poly_b
// Note: this function does not alter the contents of poly_a, and poly_b. 
void Poly_multiply(Polynomial * product, const Polynomial * poly_a, const Polynomial * poly_b)
{
	Polynomial a, b;
	for(int i=0; i<RLWE_N; i++)
	{
		a.coefficients[i] = poly_a->coefficients[i]; // a := poly_a
		b.coefficients[i] = poly_b->coefficients[i]; // b := poly_b
	}
		
	Poly_NTT_transform(&a, 1);	// perform the NTT transform on a
	Poly_NTT_transform(&b, 1);  // perform the NTT transform on b
		
	Poly_NTT_componentwise_multiply(product, &a, &b);

	Poly_NTT_transform(product, -1); // perform the NTT transform on product. 
}


// it performs the pre-computation in the negative wrapped convolution method.
// Note: since phi_table[i] contains an extra R^2 factor initially, this function makes every coefficient in ptr contain an extra R factor finally. 
void Poly_pre_NTT_computation(Polynomial * ptr)
{
	unsigned int i;

	for(i=0; i<RLWE_N; i++)
		ptr->coefficients[i] = REDC(phi_table[i], ptr->coefficients[i]);
}

// It computes the componentwise multiplication of a and b by invoking REDC algorithm, and stores their product in product
// Note: since every coefficient in both a and b contains an extra R=2^15, 
// This makes every coefficient in product contains an extra R=2^15 as well. 
void Poly_NTT_componentwise_multiply(Polynomial * product, const Polynomial * a, const Polynomial * b)
{
	unsigned int i;

	for(i=0; i<RLWE_N; i++)
		product->coefficients[i] = REDC(a->coefficients[i], b->coefficients[i]);
}


// It performs the post-computation phase in the negative wrapped convolution method by invoking REDC algorithm.
// Note: initially every coefficient in ptr contains an extra R=2^15 factor. 
void Poly_post_NTT_computation(Polynomial * ptr)
{
	unsigned int i;
	
	for(i=0; i<RLWE_N; i++)
		ptr->coefficients[i] = REDC(ptr->coefficients[i], phi_table[2*RLWE_N-1-i]);
}


// It converts the given polynomial into truncated form. 
// Before: every polynomial coefficient is in [0, 2q-1]
// After: every polynomial coefficient is in [0, q/2^t]
void Poly_truncate(Polynomial * ptr)
{
	unsigned int i;
	unsigned int temp;

	for(i=0; i<RLWE_N; i++)
	{
		temp = ModQ(ptr->coefficients[i]); 
		ptr->coefficients[i] = (temp + (1<<(RLWE_T-1))) >> RLWE_T;
	}
}


// It converts the given truncated polynomial back, by multiplying every coefficient with 2^t.
void Poly_detruncate(Polynomial * ptr)
{
	for(unsigned int i=0; i<RLWE_N; i++)
		ptr->coefficients[i] = ptr->coefficients[i] << RLWE_T;
}


// For every i, it computes (key[i],signal[i]) <- Con(ptr->coefficients[i]; nonce[i]).
// Here, the random coins are stored in noise[...].
void Poly_OKCN_Con(
		unsigned int key[RLWE_N], 
		unsigned int signal[RLWE_N], 
		const Polynomial * ptr,
		const char error[CON_ERROR_BYTES])
{
	unsigned int i, j, index;
	unsigned char temp;

	for(i=index=0; i<CON_ERROR_BYTES; i++)
		for(j=0, temp = error[i]; j<8; j++, index++, temp>>=1)
			OKCN_Con(key+index, signal+index, ptr->coefficients[index], (temp & 0x01));
}


// For every i, it computes key[i] <- Rec(ptr->coefficients[i], signal[i]).
void Poly_OKCN_Rec(
		unsigned int key[RLWE_Q], 
		const Polynomial *sigma, 
		const unsigned int signal[RLWE_Q])
{	
	for(unsigned int i=0; i<RLWE_N; i++)
		key[i] = OKCN_Rec(sigma->coefficients[i], signal[i]);
}

// It generates the uniform polynomial according to the pseudorandom sequence generated by seed. 
// Two consecutive bytes are combined to form an integer in [0, 2^16-1].
// Rejection sampling is applied to choose the random coefficients. 
void Get_uniform_poly(Polynomial * A, const unsigned char * seed)
{
	unsigned int i = 0;
	unsigned int index = 0;    
	unsigned int temp;
	unsigned char buffer[UNIFORM_POLY_SEED_EXPAND_BYTES];

   	unsigned char local_seed[UNIFORM_POLY_SEED_BYTES];
	memcpy(local_seed, seed, UNIFORM_POLY_SEED_BYTES);
		   
	AES_XOF_struct aes_state;
	seedexpander_init(&aes_state, local_seed, diversifier, 2048);
	seedexpander(&aes_state, buffer, UNIFORM_POLY_SEED_EXPAND_BYTES); 
	
	for(i=index=0; i<RLWE_N; )  
	{
		temp = (buffer[index++]);
		temp += ((buffer[index++]&0x3F) << 8); // only a, and LSB(b, 6)
		if(temp < RLWE_Q)
			A->coefficients[i++] = temp +RLWE_Q;

		if (index > UNIFORM_POLY_SEED_EXPAND_BYTES-2) // buffer is empty
		{      
			seedexpander(&aes_state, buffer, UNIFORM_POLY_SEED_EXPAND_BYTES);
			index = 0;                            
		}
	}
}

// It generates a noise polynomial according to "seed+nonce".
void Get_small_poly(Polynomial * ptr, unsigned char * seed, unsigned int nonce)
{
	unsigned char local_seed[SMALL_POLY_SEED_BYTES+1];
	unsigned char buffer[SMALL_POLY_SEED_EXPAND_BYTES];
	const unsigned char diversifier[8] = "OKCN-SEC"; 
	
	unsigned int i, j, k, round;
	int sum;
	unsigned char temp;
	unsigned int index;

	memcpy(local_seed, seed, SMALL_POLY_SEED_BYTES);
	local_seed[SMALL_POLY_SEED_BYTES] = nonce;
	
	AES_XOF_struct aes_state;
	seedexpander_init(&aes_state, local_seed, diversifier,  3072);
	
	for(round=index=0; round<4; round++)
	{
		seedexpander(&aes_state, buffer, SMALL_POLY_SEED_EXPAND_BYTES); 
		
		for(i=0;i<SMALL_POLY_SEED_EXPAND_BYTES; i+=3)
		{
			for(sum=RLWE_Q, j=i; j<i+3; j++)
				for(temp=buffer[j], k=0; k<4; k++, temp>>=2)
					sum += lookup_table[(temp&0x3)];
			ptr->coefficients[index++] = sum;
		}
	}
}

// It computes sum = sum+a, and then converts sum into truncated form if necessary (when b=1).
void Poly_add_then_truncate(Polynomial * sum, const Polynomial * p, unsigned int b)
{
	unsigned int temp;

	for(unsigned int i=0; i<RLWE_N; i++)
	{
		temp = Mod2Q(p->coefficients[i] + sum->coefficients[i]);
		if(b==1)
			sum->coefficients[i] = (ModQ(temp)+(1<<(RLWE_T-1)))>>RLWE_T;
		else
			sum->coefficients[i] = ModQ(temp);
	}
}